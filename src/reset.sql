-- PETIT RESET

-- Suppression des tables existantes
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE Recette_Ingredient CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE Recette CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE Ingredient CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE Auteur CASCADE CONSTRAINTS';
  EXECUTE IMMEDIATE 'DROP TABLE Trace CASCADE CONSTRAINTS';
EXCEPTION
  WHEN OTHERS THEN
    NULL;
END;
/


-- CRÉATION DES TABLES


-- Table Auteur
CREATE TABLE Auteur (
  id_auteur NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nom VARCHAR2(100) NOT NULL,
  email VARCHAR2(150) UNIQUE NOT NULL,
  bio VARCHAR2(1000)
);

-- Table Recette
CREATE TABLE Recette (
  id_recette NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  titre VARCHAR2(200) NOT NULL,
  description CLOB,
  instructions CLOB,
  temps_preparation NUMBER(3),
  temps_cuisson NUMBER(3),
  auteur_id NUMBER NOT NULL,
  CONSTRAINT fk_recette_auteur
    FOREIGN KEY (auteur_id)
    REFERENCES Auteur(id_auteur)
    ON DELETE CASCADE
);

-- Table Ingredient
CREATE TABLE Ingredient (
  id_ingredient NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nom VARCHAR2(100) NOT NULL,
  cote_sante NUMBER(1) NOT NULL CHECK (cote_sante BETWEEN 1 AND 5)
);

-- Table de liaison Recette_Ingredient
CREATE TABLE Recette_Ingredient (
  id_recette NUMBER NOT NULL,
  id_ingredient NUMBER NOT NULL,
  quantite VARCHAR2(100) NOT NULL,
  PRIMARY KEY (id_recette, id_ingredient),
  CONSTRAINT fk_ri_recette
    FOREIGN KEY (id_recette)
    REFERENCES Recette(id_recette)
    ON DELETE CASCADE,
  CONSTRAINT fk_ri_ingredient
    FOREIGN KEY (id_ingredient)
    REFERENCES Ingredient(id_ingredient)
    ON DELETE CASCADE
);

-- Table Trace
CREATE TABLE Trace (
  id_trace NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  table_name VARCHAR2(50) NOT NULL,
  operation_type VARCHAR2(10) NOT NULL,
  operation_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  record_id NUMBER,
  record_id2 NUMBER
);

 
-- IMPLÉMENTATION DU JOURNAL DE TRACE


-- Création de la procédure de journalisation
CREATE OR REPLACE PROCEDURE log_transaction(
  p_table_name IN VARCHAR2,
  p_operation_type IN VARCHAR2,
  p_record_id IN NUMBER,
  p_record_id2 IN NUMBER DEFAULT NULL -- valeur par défaut NULL pour les tables normales
)
AS
BEGIN
  INSERT INTO Trace (table_name, operation_type, record_id, record_id2)
  VALUES (p_table_name, p_operation_type, p_record_id, p_record_id2);
END;
/

-- Trigger de la table Auteur
CREATE OR REPLACE TRIGGER trg_auteur_trace
AFTER INSERT OR UPDATE OR DELETE ON Auteur
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    log_transaction('Auteur', 'INSERT', :NEW.id_auteur);
  ELSIF UPDATING THEN
    log_transaction('Auteur', 'UPDATE', :NEW.id_auteur);
  ELSIF DELETING THEN
    log_transaction('Auteur', 'DELETE', :OLD.id_auteur);
  END IF;
END;
/

-- Trigger de la table Recette
CREATE OR REPLACE TRIGGER trg_recette_trace
AFTER INSERT OR UPDATE OR DELETE ON Recette
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    log_transaction('Recette', 'INSERT', :NEW.id_recette);
  ELSIF UPDATING THEN
    log_transaction('Recette', 'UPDATE', :NEW.id_recette);
  ELSIF DELETING THEN
    log_transaction('Recette', 'DELETE', :OLD.id_recette);
  END IF;
END;
/

-- Trigger de la table Ingredient
CREATE OR REPLACE TRIGGER trg_ingredient_trace
AFTER INSERT OR UPDATE OR DELETE ON Ingredient
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    log_transaction('Ingredient', 'INSERT', :NEW.id_ingredient);
  ELSIF UPDATING THEN
    log_transaction('Ingredient', 'UPDATE', :NEW.id_ingredient);
  ELSIF DELETING THEN
    log_transaction('Ingredient', 'DELETE', :OLD.id_ingredient);
  END IF;
END;
/

-- Trigger de la table Recette_Ingredient
CREATE OR REPLACE TRIGGER trg_recette_ingredient_trace
AFTER INSERT OR UPDATE OR DELETE ON Recette_Ingredient
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    log_transaction('Recette_Ingredient', 'INSERT', :NEW.id_recette, :NEW.id_ingredient);
  ELSIF UPDATING THEN
    log_transaction('Recette_Ingredient', 'UPDATE', :NEW.id_recette, :NEW.id_ingredient);
  ELSIF DELETING THEN
    log_transaction('Recette_Ingredient', 'DELETE', :OLD.id_recette, :OLD.id_ingredient);
  END IF;
END;
/


-- INSERTION DES DONNÉES D'EXEMPLE


-- Auteurs
INSERT INTO Auteur (nom, email, bio) VALUES ('Marie Tremblay', 'marie@recettesqc.ca', 'Passionnée de cuisine maison et de plats traditionnels québécois.');
INSERT INTO Auteur (nom, email, bio) VALUES ('Olivier Gagnon', 'olivier@veggieblog.com', 'Chef végétarien amateur qui aime réinventer les classiques.');
INSERT INTO Auteur (nom, email, bio) VALUES ('Sophie Moreau', 'sophie@santedelice.ca', 'Spécialisée en cuisine santé et recettes rapides.');

-- Ingrédients
INSERT INTO Ingredient (nom, cote_sante) VALUES ('Oeuf', 4);
INSERT INTO Ingredient (nom, cote_sante) VALUES ('Farine blanche', 2);
INSERT INTO Ingredient (nom, cote_sante) VALUES ('Épinards', 5);
INSERT INTO Ingredient (nom, cote_sante) VALUES ('Lait', 3);
INSERT INTO Ingredient (nom, cote_sante) VALUES ('Pâtes de blé entier', 4);
INSERT INTO Ingredient (nom, cote_sante) VALUES ('Beurre', 1);

-- Recettes
INSERT INTO Recette (titre, description, instructions, temps_preparation, temps_cuisson, auteur_id)
VALUES ('Crêpes maison', 'Des crêpes moelleuses parfaites pour le déjeuner.', '1. Mélanger les ingrédients. 2. Cuire à feu moyen.', 10, 5, 1);

INSERT INTO Recette (titre, description, instructions, temps_preparation, temps_cuisson, auteur_id)
VALUES ('Salade d''épinards', 'Une salade simple et rafraîchissante.', '1. Laver les épinards. 2. Ajouter vinaigrette au goût.', 5, 0, 3);

INSERT INTO Recette (titre, description, instructions, temps_preparation, temps_cuisson, auteur_id)
VALUES ('Pâtes aux épinards et œufs', 'Pâtes santé avec œufs pochés et épinards.', '1. Cuire les pâtes. 2. Ajouter œufs pochés et épinards sautés.', 15, 10, 2);

INSERT INTO Recette (titre, description, instructions, temps_preparation, temps_cuisson, auteur_id)
VALUES ('Oeufs brouillés au beurre', 'Classique rapide pour le matin.', '1. Battre les œufs. 2. Cuire avec beurre à feu doux.', 3, 5, 1);

-- Recette_Ingredient (liaisons avec quantités)
INSERT INTO Recette_Ingredient VALUES (1, 1, '2 œufs');
INSERT INTO Recette_Ingredient VALUES (1, 2, '1 tasse de farine');
INSERT INTO Recette_Ingredient VALUES (1, 4, '1 tasse de lait');
INSERT INTO Recette_Ingredient VALUES (2, 3, '2 tasses d’épinards');
INSERT INTO Recette_Ingredient VALUES (3, 1, '2 œufs');
INSERT INTO Recette_Ingredient VALUES (3, 3, '1 tasse d’épinards');
INSERT INTO Recette_Ingredient VALUES (3, 5, '200g de pâtes');
INSERT INTO Recette_Ingredient VALUES (4, 1, '3 œufs');
INSERT INTO Recette_Ingredient VALUES (4, 6, '1 c. à soupe de beurre');